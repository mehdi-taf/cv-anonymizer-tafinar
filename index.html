<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV Anonymizer - TAFINAR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Header Application */
        .app-header {
            background: linear-gradient(135deg, #004199 0%, #0056cc 100%);
            padding: 25px 0;
            color: white;
            box-shadow: 0 4px 20px rgba(0, 65, 153, 0.3);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .app-logo {
            height: 60px;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .app-logo img {
            height: 100%;
            width: auto;
        }

        .header-text h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header-text p {
            font-size: 16px;
            opacity: 0.9;
        }

        /* Main Container */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
        }

        /* Sections */
        .section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 65, 153, 0.1);
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: #004199;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-title::before {
            content: "";
            width: 5px;
            height: 24px;
            background: linear-gradient(180deg, #004199 0%, #00bf63 100%);
            border-radius: 3px;
        }

        /* Upload Zone */
        .upload-zone {
            border: 3px dashed #004199;
            border-radius: 15px;
            padding: 50px 30px;
            text-align: center;
            background: rgba(0, 65, 153, 0.03);
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 25px;
            position: relative;
        }

        .upload-zone:hover, .upload-zone.dragover {
            border-color: #00bf63;
            background: rgba(0, 191, 99, 0.08);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 191, 99, 0.2);
        }

        .upload-icon {
            font-size: 60px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .upload-zone:hover .upload-icon {
            transform: scale(1.1);
        }

        .upload-text {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 500;
        }

        .upload-formats {
            font-size: 14px;
            color: #666;
            font-weight: 400;
        }

        .file-input {
            display: none;
        }

        /* Zone de texte ÉNORME pour CV de 30 pages */
        .cv-text-input {
            width: 100%;
            min-height: 500px; /* Énorme pour 30 pages */
            max-height: 800px;
            padding: 20px;
            border: 2px solid #e8ecf4;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            resize: vertical;
            margin-bottom: 25px;
            transition: all 0.3s ease;
            background: #fafbfc;
            overflow-y: auto;
        }

        .cv-text-input:focus {
            outline: none;
            border-color: #004199;
            background: white;
            box-shadow: 0 0 0 4px rgba(0, 65, 153, 0.1);
        }

        .cv-text-input::placeholder {
            color: #999;
            font-size: 11px;
            line-height: 1.4;
        }

        /* Caractères counter pour gros CV */
        .char-counter {
            text-align: right;
            font-size: 12px;
            color: #666;
            margin-bottom: 20px;
            padding: 5px 0;
        }

        /* Form Fields */
        .form-grid {
            display: grid;
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-label.required::after {
            content: " *";
            color: #dc3545;
        }

        .form-input {
            padding: 15px;
            border: 2px solid #e8ecf4;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #fafbfc;
        }

        .form-input:focus {
            outline: none;
            border-color: #004199;
            background: white;
            box-shadow: 0 0 0 3px rgba(0, 65, 153, 0.1);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        /* Sauvegarde automatique indicator */
        .auto-save-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #666;
            margin-bottom: 20px;
        }

        .save-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00bf63;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Buttons */
        .btn {
            padding: 18px 35px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #004199 0%, #0056cc 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 65, 153, 0.4);
            width: 100%;
            font-size: 18px;
            padding: 20px;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 65, 153, 0.5);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success {
            background: linear-gradient(135deg, #00bf63 0%, #00d66c 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 191, 99, 0.4);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 191, 99, 0.5);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
            transform: translateY(-2px);
        }

        /* Preview Section */
        .cv-preview {
            border: 2px solid #e8ecf4;
            border-radius: 12px;
            background: white;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            min-height: 600px;
        }

        /* CV Styles optimisés pour impression */
        .cv-container {
            max-width: 100%;
            background: white;
            font-size: 11px;
            line-height: 1.5;
        }

        .cv-header {
            background: linear-gradient(135deg, #004199 0%, #0056cc 100%);
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        .cv-logo-container {
            background: white;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .cv-logo-container img {
            height: 45px;
            width: auto;
        }

        .cv-profile-info {
            text-align: center;
            flex: 1;
            margin-left: 40px;
        }

        .cv-job-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .cv-profile-code {
            font-size: 13px;
            font-weight: 700;
            color: #00ff7f;
            background: rgba(0, 255, 127, 0.15);
            padding: 6px 16px;
            border-radius: 20px;
            display: inline-block;
            border: 1px solid rgba(0, 255, 127, 0.3);
        }

        .cv-content {
            padding: 30px 35px;
            background: white;
        }

        /* Contenu CV préservé EXACTEMENT */
        .cv-raw-content {
            white-space: pre-line;
            font-size: 11px;
            line-height: 1.6;
            color: #333;
            margin: 20px 0;
        }

        .cv-raw-content h1, .cv-raw-content h2, .cv-raw-content h3 {
            color: #004199;
            margin: 20px 0 10px 0;
            font-weight: 700;
        }

        .cv-raw-content h1 {
            font-size: 14px;
            text-transform: uppercase;
            background: linear-gradient(135deg, #004199 0%, #0056cc 100%);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            text-align: center;
            margin: 25px 0 15px 0;
        }

        .cv-raw-content h2 {
            font-size: 13px;
            border-left: 4px solid #004199;
            padding-left: 15px;
            margin: 20px 0 10px 0;
        }

        .cv-raw-content h3 {
            font-size: 12px;
            color: #00bf63;
            margin: 15px 0 8px 0;
        }

        .cv-raw-content ul, .cv-raw-content ol {
            margin: 10px 0 10px 20px;
        }

        .cv-raw-content li {
            margin-bottom: 5px;
            line-height: 1.5;
        }

        .cv-raw-content p {
            margin: 8px 0;
            text-align: justify;
        }

        /* Messages */
        .message {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
            font-weight: 500;
        }

        .message.show {
            display: block;
        }

        .message-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* Actions */
        .actions {
            display: none;
            gap: 15px;
            margin-top: 25px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .actions.show {
            display: flex;
        }

        /* Internal Info avec sauvegarde */
        .internal-info {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin-top: 25px;
        }

        .info-grid {
            display: grid;
            gap: 10px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #004199;
            font-size: 13px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        }

        .info-label {
            font-weight: 600;
            color: #004199;
        }

        .info-value {
            color: #333;
            font-style: italic;
        }

        /* Loading optimisé pour gros CV */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 400px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #004199;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #333;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .loading-subtext {
            color: #666;
            font-size: 14px;
        }

        .loading-progress {
            margin-top: 15px;
            font-size: 12px;
            color: #004199;
            font-weight: 600;
        }

        /* Styles d'impression parfaits */
        @media print {
            body * {
                visibility: hidden;
            }
            
            .cv-preview, .cv-preview * {
                visibility: visible;
            }
            
            .cv-preview {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
                border: none;
                border-radius: 0;
                box-shadow: none;
            }
            
            .cv-header {
                border-radius: 0;
                page-break-inside: avoid;
            }
            
            .cv-content {
                page-break-inside: auto;
            }
            
            .cv-raw-content h1 {
                page-break-after: avoid;
            }
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr;
                max-width: 900px;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }

            .main-container {
                padding: 20px 15px;
                gap: 25px;
            }

            .section {
                padding: 20px;
            }

            .cv-text-input {
                min-height: 400px;
                font-size: 11px;
            }

            .cv-header {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }

            .cv-profile-info {
                margin-left: 0;
            }

            .actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="app-header">
        <div class="header-content">
            <div class="app-logo">
                <img src="https://image.jimcdn.com/app/cms/image/transf/dimension=400x10000:format=png/path/sff9eaf88e82d8f8a/image/ifdd007cf2d2293e3/version/1616433262/image.png" alt="TAFINAR">
            </div>
            <div class="header-text">
                <h1>CV Anonymizer</h1>
                <p>Anonymisation intelligente de CV jusqu'à 30 pages</p>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Input Section -->
        <div class="section">
            <div class="section-title">CV à traiter</div>
            
            <!-- Upload Zone -->
            <div class="upload-zone" id="uploadZone">
                <div class="upload-icon">📄</div>
                <div class="upload-text">Glissez-déposez votre CV ici ou cliquez pour sélectionner</div>
                <div class="upload-formats">Formats supportés : PDF, DOC, DOCX (jusqu'à 30 pages)</div>
                <input type="file" id="fileInput" class="file-input" accept=".pdf,.doc,.docx">
            </div>

            <div style="text-align: center; margin: 20px 0; color: #666; font-weight: 600; font-size: 16px;">OU</div>

            <!-- Text Input ÉNORME -->
            <textarea 
                id="cvTextInput" 
                class="cv-text-input" 
                placeholder="Collez ici le texte complet de votre CV (même très long, jusqu'à 30 pages)...

EXEMPLE POUR CV LONG :
=====================================

DUPONT Jean
123 rue de la République  
75001 Paris
jean.dupont@email.com
06 12 34 56 78

PROFIL PROFESSIONNEL
Ingénieur expérimenté avec 15 ans d'expertise...
[Texte long du profil...]

EXPÉRIENCE PROFESSIONNELLE

Senior Manager - ABC Corporation
Janvier 2020 - Présent | Paris, France
• Direction d'équipe de 25 personnes
• Gestion de budget annuel de 5M€
• Développement de nouvelles stratégies commerciales
• [Toutes vos missions détaillées...]

Chef de Projet - XYZ Consulting  
Mars 2017 - Décembre 2019 | Lyon, France
• Pilotage de projets complexes
• [Toutes vos réalisations...]

FORMATION

Master Management - École Supérieure
2015-2017 | Mention Très Bien
Spécialisation : Stratégie d'entreprise
Mémoire : [Titre complet du mémoire...]

COMPÉTENCES TECHNIQUES
• Leadership et management d'équipes
• Gestion de projets (PMP, Agile)
• Analyses financières avancées
• [Toutes vos compétences...]

LANGUES
• Français : Natif
• Anglais : Courant (TOEIC 950)
• Espagnol : Intermédiaire

PROJETS SIGNIFICATIFS
[Décrivez tous vos projets en détail...]

PUBLICATIONS & CONFÉRENCES  
[Listez toutes vos publications...]

CENTRES D'INTÉRÊT
[Vos hobbies et passions...]

=====================================
Continuez avec TOUT votre contenu...
Le système traitera automatiquement même les CV très longs !"></textarea>

            <div class="char-counter" id="charCounter">0 caractères</div>

            <!-- Auto-save status -->
            <div class="auto-save-status" id="autoSaveStatus" style="display: none;">
                <div class="save-dot"></div>
                <span>Sauvegarde automatique activée</span>
            </div>

            <!-- Form Fields -->
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label required">Poste recherché</label>
                    <input type="text" id="jobTitle" class="form-input" placeholder="Ex: Senior Manager / Ingénieur Systèmes" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Code profil (optionnel)</label>
                    <input type="text" id="profileCode" class="form-input" placeholder="Ex: ABC (généré automatiquement si vide)">
                </div>

                <div class="form-group">
                    <label class="form-label">Disponibilité</label>
                    <input type="text" id="availability" class="form-input" placeholder="Ex: Immédiate, 2 mois de préavis...">
                </div>

                <div class="form-group">
                    <label class="form-label">Mobilité géographique</label>
                    <input type="text" id="mobility" class="form-input" placeholder="Ex: France entière, International, Région Parisienne...">
                </div>

                <div class="form-group">
                    <label class="form-label">Prétention salariale</label>
                    <input type="text" id="salary" class="form-input" placeholder="Ex: 65-75k€, À négocier selon poste...">
                </div>

                <div class="form-group">
                    <label class="form-label">Remarques générales</label>
                    <textarea id="remark" class="form-input form-textarea" placeholder="Remarques sur le profil, points forts, spécificités..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Notes pour Soufyane</label>
                    <textarea id="soufyaneRemark" class="form-input form-textarea" placeholder="Notes internes, commentaires stratégiques..."></textarea>
                </div>
            </div>

            <!-- Generate Button -->
            <button type="button" id="generateBtn" class="btn btn-primary">
                <span>Analyser et générer le CV anonyme</span>
            </button>

            <!-- Messages -->
            <div id="successMessage" class="message message-success">
                CV anonyme généré avec succès ! Toutes les données sont sauvegardées.
            </div>
            <div id="errorMessage" class="message message-error">
                Erreur lors de la génération. Vérifiez les données ou réessayez.
            </div>
            <div id="apiKeyMessage" class="message message-info" style="cursor: pointer;">
                Cliquez ici pour configurer votre clé API et utiliser l'outil.
            </div>
        </div>

        <!-- Preview Section -->
        <div class="section">
            <div class="section-title">Aperçu du CV anonyme</div>
            
            <div id="cvPreview" class="cv-preview">
                <div class="cv-container">
                    <div class="cv-header">
                        <div class="cv-logo-container">
                            <img src="https://image.jimcdn.com/app/cms/image/transf/dimension=400x10000:format=png/path/sff9eaf88e82d8f8a/image/ifdd007cf2d2293e3/version/1616433262/image.png" alt="TAFINAR">
                        </div>
                        <div class="cv-profile-info">
                            <div class="cv-job-title" id="previewJobTitle">Poste à définir</div>
                            <div class="cv-profile-code" id="previewProfileCode">PROFIL XXX</div>
                        </div>
                    </div>
                    <div class="cv-content">
                        <div id="previewContent" class="cv-raw-content">
                            <div style="text-align: center; color: #666; padding: 50px 20px;">
                                <p style="font-size: 16px; margin-bottom: 15px;">L'aperçu du CV anonyme apparaîtra ici</p>
                                <p style="font-size: 14px; margin-bottom: 10px;">Fournissez un CV (même très long) et cliquez sur "Analyser"</p>
                                <p style="font-size: 12px; color: #999;">Le système préserve tout le contenu professionnel</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div id="previewActions" class="actions">
                <button type="button" id="downloadBtn" class="btn btn-success">
                    Télécharger PDF
                </button>
                <button type="button" id="printBtn" class="btn btn-primary">
                    Imprimer
                </button>
                <button type="button" id="modifyBtn" class="btn btn-secondary">
                    Modifier
                </button>
            </div>

            <!-- Internal Info avec sauvegarde -->
            <div id="internalInfo" class="internal-info">
                <div class="section-title">Informations sauvegardées</div>
                <div id="infoGrid" class="info-grid"></div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay pour gros CV -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Analyse en cours...</div>
            <div class="loading-subtext">L'IA traite votre CV complet</div>
            <div class="loading-progress" id="loadingProgress"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configuration IA renforcée pour gros CV
        const AI_CONFIG = {
            apiUrl: 'https://openrouter.ai/api/v1/chat/completions',
            apiKey: '',
            model: 'anthropic/claude-3.5-sonnet' // Le plus puissant pour CV de 30 pages
        };

        // Variables globales pour sauvegarde
        let currentCvData = null;
        let autoSaveInterval = null;

        // Elements DOM
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const cvTextInput = document.getElementById('cvTextInput');
        const generateBtn = document.getElementById('generateBtn');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const cvPreview = document.getElementById('cvPreview');
        const previewActions = document.getElementById('previewActions');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        const apiKeyMessage = document.getElementById('apiKeyMessage');
        const internalInfo = document.getElementById('internalInfo');
        const charCounter = document.getElementById('charCounter');
        const autoSaveStatus = document.getElementById('autoSaveStatus');

        // Event Listeners
        uploadZone.addEventListener('click', () => fileInput.click());
        uploadZone.addEventListener('dragover', handleDragOver);
        uploadZone.addEventListener('dragleave', handleDragLeave);
        uploadZone.addEventListener('drop', handleDrop);
        fileInput.addEventListener('change', handleFileSelect);
        generateBtn.addEventListener('click', generateAnonymousCV);
        document.getElementById('downloadBtn').addEventListener('click', downloadPDF);
        document.getElementById('printBtn').addEventListener('click', printCV);
        document.getElementById('modifyBtn').addEventListener('click', enableModification);
        apiKeyMessage.addEventListener('click', showApiKeyPrompt);

        // Character counter pour gros CV
        cvTextInput.addEventListener('input', updateCharCounter);
        cvTextInput.addEventListener('input', debounceAutoSave);

        // Auto-save pour tous les champs
        const formInputs = ['jobTitle', 'profileCode', 'availability', 'mobility', 'salary', 'remark', 'soufyaneRemark'];
        formInputs.forEach(id => {
            document.getElementById(id).addEventListener('input', debounceAutoSave);
        });

        function updateCharCounter() {
            const count = cvTextInput.value.length;
            charCounter.textContent = `${count.toLocaleString()} caractères`;
            
            if (count > 100000) {
                charCounter.style.color = '#dc3545';
                charCounter.textContent += ' (CV très long - traitement optimisé)';
            } else if (count > 50000) {
                charCounter.style.color = '#fd7e14';
                charCounter.textContent += ' (CV long)';
            } else {
                charCounter.style.color = '#666';
            }
        }

        // Debounced auto-save
        let autoSaveTimeout;
        function debounceAutoSave() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(autoSave, 2000);
        }

        function autoSave() {
            const formData = collectFormData();
            localStorage.setItem('cv_anonymizer_data', JSON.stringify(formData));
            
            autoSaveStatus.style.display = 'flex';
            setTimeout(() => {
                autoSaveStatus.style.display = 'none';
            }, 3000);
        }

        function collectFormData() {
            return {
                cvText: cvTextInput.value,
                jobTitle: document.getElementById('jobTitle').value,
                profileCode: document.getElementById('profileCode').value,
                availability: document.getElementById('availability').value,
                mobility: document.getElementById('mobility').value,
                salary: document.getElementById('salary').value,
                remark: document.getElementById('remark').value,
                soufyaneRemark: document.getElementById('soufyaneRemark').value,
                timestamp: new Date().toISOString()
            };
        }

        function loadSavedData() {
            const saved = localStorage.getItem('cv_anonymizer_data');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    cvTextInput.value = data.cvText || '';
                    document.getElementById('jobTitle').value = data.jobTitle || '';
                    document.getElementById('profileCode').value = data.profileCode || '';
                    document.getElementById('availability').value = data.availability || '';
                    document.getElementById('mobility').value = data.mobility || '';
                    document.getElementById('salary').value = data.salary || '';
                    document.getElementById('remark').value = data.remark || '';
                    document.getElementById('soufyaneRemark').value = data.soufyaneRemark || '';
                    updateCharCounter();
                    
                    // Charger le CV généré s'il existe
                    const savedCV = localStorage.getItem('cv_anonymizer_generated');
                    if (savedCV) {
                        currentCvData = JSON.parse(savedCV);
                        displaySavedCV();
                    }
                } catch (e) {
                    console.log('Erreur chargement données sauvegardées');
                }
            }
        }

        function displaySavedCV() {
            if (currentCvData) {
                document.getElementById('previewJobTitle').textContent = currentCvData.jobTitle;
                document.getElementById('previewProfileCode').textContent = `PROFIL ${currentCvData.profileCode}`;
                document.getElementById('previewContent').innerHTML = currentCvData.anonymizedContent;
                previewActions.classList.add('show');
                displayInternalInfo();
            }
        }

        // Drag & Drop handlers
        function handleDragOver(e) {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        // File processing amélioré pour gros PDF
        async function processFile(file) {
            try {
                showLoading('Extraction du texte...', 'Traitement en cours pour fichier volumineux');
                
                let text = '';
                const maxSize = 50 * 1024 * 1024; // 50MB max
                
                if (file.size > maxSize) {
                    throw new Error('Fichier trop volumineux (max 50MB)');
                }
                
                if (file.type === 'application/pdf') {
                    text = await extractTextFromPDF(file);
                } else if (file.type.includes('word') || file.name.endsWith('.docx') || file.name.endsWith('.doc')) {
                    text = await extractTextFromWord(file);
                } else {
                    throw new Error('Format non supporté. Utilisez PDF, DOC ou DOCX.');
                }

                if (text.length < 100) {
                    throw new Error('Le texte extrait semble trop court. Vérifiez le fichier ou utilisez la zone de texte.');
                }

                cvTextInput.value = text;
                uploadZone.querySelector('.upload-text').textContent = `Fichier chargé : ${file.name}`;
                updateCharCounter();
                hideLoading();
                showMessage('success', `Fichier traité avec succès ! ${text.length.toLocaleString()} caractères extraits.`);
                
            } catch (error) {
                hideLoading();
                showMessage('error', 'Erreur traitement fichier : ' + error.message);
            }
        }

        // PDF extraction optimisée pour 30 pages
        async function extractTextFromPDF(file) {
            return new Promise(async (resolve, reject) => {
                try {
                    pdfjsLib.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({
                        data: arrayBuffer,
                        verbosity: 0
                    }).promise;
                    
                    let fullText = '';
                    const totalPages = pdf.numPages;

                    if (totalPages > 30) {
                        updateLoadingProgress(`Document très volumineux (${totalPages} pages). Traitement en cours...`);
                    }

                    for (let i = 1; i <= totalPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        
                        const pageText = textContent.items
                            .map(item => item.str)
                            .join(' ')
                            .replace(/\s+/g, ' ')
                            .trim();
                        
                        if (pageText) {
                            fullText += pageText + '\n\n';
                        }
                        
                        // Progress update pour gros documents
                        if (totalPages > 5) {
                            const progress = Math.round((i / totalPages) * 100);
                            updateLoadingProgress(`Page ${i}/${totalPages} (${progress}%)`);
                        }
                    }

                    if (fullText.trim().length === 0) {
                        throw new Error('Aucun texte extractible du PDF');
                    }

                    resolve(fullText.trim());
                } catch (error) {
                    reject(error);
                }
            });
        }

        async function extractTextFromWord(file) {
            throw new Error('Extraction Word non disponible. Copiez-collez le contenu dans la zone de texte.');
        }

        // Génération CV anonyme TOTALEMENT préservée
        async function generateAnonymousCV() {
            const cvText = cvTextInput.value.trim();
            const jobTitle = document.getElementById('jobTitle').value.trim();

            if (!cvText) {
                showMessage('error', 'Veuillez fournir le contenu du CV');
                return;
            }

            if (!jobTitle) {
                showMessage('error', 'Veuillez saisir le poste recherché');
                return;
            }

            if (!AI_CONFIG.apiKey) {
                showMessage('info', 'Cliquez ici pour configurer votre clé API');
                return;
            }

            try {
                showLoading('Analyse IA en cours...', 'Traitement intelligent du CV complet');
                
                const analysisResult = await analyzeCV(cvText);
                
                if (analysisResult) {
                    const profileCode = document.getElementById('profileCode').value.trim() || 
                                     generateProfileCode();

                    currentCvData = {
                        jobTitle: jobTitle,
                        profileCode: profileCode,
                        anonymizedContent: analysisResult,
                        originalLength: cvText.length,
                        processedAt: new Date().toISOString()
                    };

                    // Sauvegarde du CV généré
                    localStorage.setItem('cv_anonymizer_generated', JSON.stringify(currentCvData));
                    
                    displayAnonymousCV();
                    displayInternalInfo();
                    showMessage('success', 'CV anonyme généré et sauvegardé avec succès !');
                } else {
                    throw new Error('Aucune réponse de l\'IA');
                }

            } catch (error) {
                showMessage('error', 'Erreur : ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // IA Analysis TOTALEMENT préservée - ZÉRO modification
        async function analyzeCV(cvText) {
            const prompt = `Tu es un expert en anonymisation de CV. Ta mission est de PRÉSERVER EXACTEMENT tout le contenu professionnel et de supprimer UNIQUEMENT les informations personnelles.

RÈGLES ABSOLUES :
1. SUPPRIME UNIQUEMENT : nom, prénom, email, téléphone, adresse personnelle complète
2. GARDE ABSOLUMENT TOUT LE RESTE sans aucune modification
3. INTERDICTION FORMELLE de résumer, raccourcir, reformuler ou changer quoi que ce soit
4. Préserve CHAQUE mot, CHAQUE phrase, CHAQUE détail professionnel
5. Conserve la structure exacte, les dates, lieux, entreprises, missions
6. Garde TOUS les projets, réalisations, compétences, formations
7. Préserve les descriptions longues et détaillées

PROCESSUS :
1. Identifie les infos personnelles à supprimer
2. Supprime-les proprement
3. Retourne EXACTEMENT tout le reste tel quel
4. Applique une mise en forme HTML simple pour la lisibilité

CV à traiter (peut être très long, jusqu'à 30 pages) :
${cvText}

Réponds avec le CV anonymisé en HTML simple, en gardant EXACTEMENT tout le contenu professionnel :`;

            try {
                const response = await fetch(AI_CONFIG.apiUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${AI_CONFIG.apiKey}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.origin
                    },
                    body: JSON.stringify({
                        model: AI_CONFIG.model,
                        messages: [
                            {
                                role: 'system', 
                                content: 'Tu es un expert en anonymisation de CV. Tu préserves EXACTEMENT tout le contenu professionnel et supprimes seulement les infos personnelles. Tu réponds en HTML simple et propre.'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        max_tokens: 8000,
                        temperature: 0.05 // Précision maximale
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Erreur API ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                const content = data.choices[0].message.content;
                
                // Nettoyer le HTML s'il y a des balises markdown
                const cleanContent = content
                    .replace(/```html/g, '')
                    .replace(/```/g, '')
                    .trim();

                return cleanContent;

            } catch (error) {
                console.error('Erreur IA:', error);
                if (error.message.includes('rate limit')) {
                    throw new Error('Limite API atteinte. Attendez quelques instants.');
                }
                throw error;
            }
        }

        function displayAnonymousCV() {
            if (currentCvData) {
                document.getElementById('previewJobTitle').textContent = currentCvData.jobTitle;
                document.getElementById('previewProfileCode').textContent = `PROFIL ${currentCvData.profileCode}`;
                document.getElementById('previewContent').innerHTML = currentCvData.anonymizedContent;
                previewActions.classList.add('show');
            }
        }

        function generateProfileCode() {
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            return Array.from({length: 3}, () => letters[Math.floor(Math.random() * letters.length)]).join('');
        }

        function displayInternalInfo() {
            const formData = collectFormData();
            const data = {
                'Poste recherché': formData.jobTitle || 'Non spécifié',
                'Code profil': currentCvData?.profileCode || 'Non généré',
                'Disponibilité': formData.availability || 'Non spécifiée',
                'Mobilité': formData.mobility || 'Non spécifiée',
                'Prétention salariale': formData.salary || 'Non spécifiée',
                'Remarque': formData.remark || 'Aucune',
                'Notes pour Soufyane': formData.soufyaneRemark || 'Aucune',
                'Taille CV original': currentCvData ? `${currentCvData.originalLength.toLocaleString()} caractères` : 'N/A',
                'Traité le': currentCvData ? new Date(currentCvData.processedAt).toLocaleString('fr-FR') : 'N/A'
            };

            let html = '';
            Object.entries(data).forEach(([label, value]) => {
                html += `
                    <div class="info-item">
                        <span class="info-label">${label} :</span>
                        <span class="info-value">${value}</span>
                    </div>
                `;
            });

            document.getElementById('infoGrid').innerHTML = html;
            internalInfo.style.display = 'block';
        }

        // Actions
        function downloadPDF() {
            if (!currentCvData) {
                showMessage('error', 'Aucun CV à télécharger');
                return;
            }

            try {
                // Créer une nouvelle fenêtre pour l'impression
                const printWindow = window.open('', '_blank');
                const cvContent = document.getElementById('cvPreview').innerHTML;
                
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>CV_PROFIL_${currentCvData.profileCode}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
                            .cv-container { max-width: 800px; margin: 0 auto; }
                            .cv-header { background: linear-gradient(135deg, #004199 0%, #0056cc 100%); padding: 25px 30px; display: flex; justify-content: space-between; align-items: center; color: white; }
                            .cv-logo-container { background: white; padding: 12px 16px; border-radius: 8px; }
                            .cv-logo-container img { height: 45px; width: auto; }
                            .cv-profile-info { text-align: center; flex: 1; margin-left: 40px; }
                            .cv-job-title { font-size: 16px; font-weight: 700; margin-bottom: 8px; }
                            .cv-profile-code { font-size: 13px; font-weight: 700; color: #00ff7f; background: rgba(0, 255, 127, 0.15); padding: 6px 16px; border-radius: 20px; display: inline-block; border: 1px solid rgba(0, 255, 127, 0.3); }
                            .cv-content { padding: 30px 35px; background: white; }
                            .cv-raw-content { font-size: 11px; line-height: 1.6; color: #333; }
                            .cv-raw-content h1 { color: #004199; font-size: 14px; text-transform: uppercase; background: linear-gradient(135deg, #004199 0%, #0056cc 100%); color: white; padding: 8px 20px; border-radius: 20px; text-align: center; margin: 25px 0 15px 0; }
                            .cv-raw-content h2 { font-size: 13px; color: #004199; border-left: 4px solid #004199; padding-left: 15px; margin: 20px 0 10px 0; }
                            .cv-raw-content h3 { font-size: 12px; color: #00bf63; margin: 15px 0 8px 0; }
                            .cv-raw-content ul, .cv-raw-content ol { margin: 10px 0 10px 20px; }
                            .cv-raw-content li { margin-bottom: 5px; line-height: 1.5; }
                            .cv-raw-content p { margin: 8px 0; text-align: justify; }
                        </style>
                    </head>
                    <body>
                        ${cvContent}
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
                
                setTimeout(() => {
                    printWindow.focus();
                    printWindow.print();
                }, 500);
                
                showMessage('success', 'Ouverture de la fenêtre d\'impression PDF');
                
            } catch (error) {
                showMessage('error', 'Erreur téléchargement : ' + error.message);
            }
        }

        function printCV() {
            window.print();
        }

        function enableModification() {
            // Permettre la modification après génération
            cvTextInput.scrollIntoView({ behavior: 'smooth' });
            cvTextInput.focus();
            showMessage('info', 'Vous pouvez maintenant modifier et régénérer le CV');
        }

        // Utility functions
        function showLoading(message = 'Chargement...', subtext = '') {
            document.querySelector('.loading-text').textContent = message;
            document.querySelector('.loading-subtext').textContent = subtext;
            loadingOverlay.style.display = 'flex';
            generateBtn.disabled = true;
        }

        function updateLoadingProgress(progress) {
            document.getElementById('loadingProgress').textContent = progress;
        }

        function hideLoading() {
            loadingOverlay.style.display = 'none';
            generateBtn.disabled = false;
            document.getElementById('loadingProgress').textContent = '';
        }

        function showMessage(type, message) {
            hideMessages();
            let element;
            if (type === 'success') element = successMessage;
            else if (type === 'error') element = errorMessage;
            else if (type === 'info') element = apiKeyMessage;
            
            if (element) {
                element.textContent = message;
                element.classList.add('show');
                setTimeout(hideMessages, type === 'error' ? 10000 : 6000);
            }
        }

        function hideMessages() {
            successMessage.classList.remove('show');
            errorMessage.classList.remove('show');
            apiKeyMessage.classList.remove('show');
        }

        function showApiKeyPrompt() {
            const apiKey = prompt(`Configuration de la clé API OpenRouter

1. Créez un compte gratuit sur openrouter.ai
2. Obtenez votre clé API dans votre dashboard
3. Collez votre clé ici (format: sk-or-xxxxx)

Coût approximatif: 2-5€ pour 100 CV longs`);
            
            if (apiKey && apiKey.startsWith('sk-or-')) {
                AI_CONFIG.apiKey = apiKey;
                localStorage.setItem('openrouter_api_key', apiKey);
                showMessage('success', 'Clé API configurée avec succès ! L\'outil est prêt à l\'utilisation.');
            } else if (apiKey) {
                showMessage('error', 'Format invalide. La clé doit commencer par sk-or-');
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            // Charger la clé API
            const savedApiKey = localStorage.getItem('openrouter_api_key');
            if (savedApiKey) {
                AI_CONFIG.apiKey = savedApiKey;
            }

            // Charger les données sauvegardées
            loadSavedData();
            
            // Initialiser le counter
            updateCharCounter();
            
            console.log('CV Anonymizer initialisé - Prêt pour CV jusqu\'à 30 pages');
        });

        // Styles d'impression intégrés
        const printStyles = document.createElement('style');
        printStyles.textContent = `
            @media print {
                body * { visibility: hidden; }
                .cv-preview, .cv-preview * { visibility: visible; }
                .cv-preview { 
                    position: absolute; 
                    left: 0; 
                    top: 0; 
                    width: 100%; 
                    height: 100%;
                    border: none !important;
                    border-radius: 0 !important;
                    box-shadow: none !important;
                }
                .cv-header { border-radius: 0 !important; page-break-inside: avoid; }
                .cv-content { page-break-inside: auto; }
                .cv-raw-content h1 { page-break-after: avoid; }
                .cv-raw-content { page-break-inside: auto; }
            }
        `;
        document.head.appendChild(printStyles);
    </script>
</body>
</html>
